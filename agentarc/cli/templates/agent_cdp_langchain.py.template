"""
{project_name} - AgentARC Protected Agent (Coinbase CDP + LangChain)
"""
import os
from dotenv import load_dotenv
load_dotenv()

from langchain_openai import ChatOpenAI
from langgraph.prebuilt import create_react_agent
from langgraph.checkpoint.memory import MemorySaver
from coinbase_agentkit import CdpEvmWalletProvider, CdpWalletProviderConfig
from agentarc import WalletFactory, PolicyWallet, LangChainAdapter

# 1. Create CDP wallet
cdp_config = CdpWalletProviderConfig(network_id=os.environ.get("NETWORK_ID", "base-sepolia"))
cdp_provider = CdpEvmWalletProvider(cdp_config)
wallet = WalletFactory.from_cdp(cdp_provider)

# 2. Wrap with policy enforcement
policy_wallet = PolicyWallet(wallet, config_path="policy.yaml")

# 3. Create LangChain agent
adapter = LangChainAdapter()
tools = adapter.create_all_tools(policy_wallet)
llm = ChatOpenAI(model="gpt-4o-mini", api_key=os.environ["OPENAI_API_KEY"])
agent = create_react_agent(llm, tools=tools, checkpointer=MemorySaver())

print(f"Wallet: {{policy_wallet.get_address()}}")
print(f"Policies active: {{len(policy_wallet.get_config().get_enabled_policies())}}")

# 4. Chat loop
config = {{"configurable": {{"thread_id": "main"}}}}
while True:
    user_input = input("\nYou: ")
    if user_input.lower() in ("quit", "exit"):
        break

    for event in agent.stream(
        {{"messages": [{{"role": "user", "content": user_input}}]}}, config=config
    ):
        if "agent" in event:
            print(f"\nAgent: {{event['agent']['messages'][0].content}}")
